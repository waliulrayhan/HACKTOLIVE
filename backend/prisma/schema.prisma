// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  password  String
  role      UserRole @default(STUDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  instructor    Instructor?
  student       Student?
  reviews       Review[]
}

enum UserRole {
  STUDENT
  INSTRUCTOR
  ADMIN
}

// ============================================
// ACADEMY - INSTRUCTORS
// ============================================

model Instructor {
  id              String   @id @default(uuid())
  userId          String   @unique
  name            String
  avatar          String?
  bio             String?  @db.Text
  experience      String?
  skills          String[] // Array of skill names
  rating          Float    @default(0)
  totalStudents   Int      @default(0)
  totalCourses    Int      @default(0)
  linkedinUrl     String?
  twitterUrl      String?
  githubUrl       String?
  websiteUrl      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courses         Course[]

  @@index([rating])
  @@index([totalStudents])
}

// ============================================
// ACADEMY - STUDENTS
// ============================================

model Student {
  id                  String        @id @default(uuid())
  userId              String        @unique
  name                String
  email               String        @unique
  avatar              String?
  phone               String?
  enrolledCourses     Int           @default(0)
  completedCourses    Int           @default(0)
  certificatesEarned  Int           @default(0)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments         Enrollment[]
  certificates        Certificate[]
  progress            LessonProgress[]
  quizAttempts        QuizAttempt[]
  assignmentSubmissions AssignmentSubmission[]

  @@index([email])
}

// ============================================
// ACADEMY - COURSES
// ============================================

model Course {
  id                  String        @id @default(uuid())
  slug                String        @unique
  title               String
  shortDescription    String        @db.Text
  description         String        @db.Text
  thumbnail           String?
  category            CourseCategory
  level               CourseLevel
  tier                CourseTier
  deliveryMode        DeliveryMode
  price               Float         @default(0)
  instructorId        String
  rating              Float         @default(0)
  totalRatings        Int           @default(0)
  totalStudents       Int           @default(0)
  duration            Int           // Total duration in minutes
  totalLessons        Int           @default(0)
  totalModules        Int           @default(0)
  learningOutcomes    String[]      // Array of learning outcomes
  requirements        String[]      // Array of requirements
  tags                String[]      // Array of tags
  
  // Live class specific fields
  liveSchedule        String?       // e.g., "Mon, Wed, Fri - 8:00 PM"
  startDate           DateTime?
  endDate             DateTime?
  maxStudents         Int?
  enrolledStudents    Int           @default(0)
  meetingLink         String?
  
  status              CourseStatus  @default(DRAFT)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  instructor          Instructor    @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  modules             CourseModule[]
  enrollments         Enrollment[]
  reviews             Review[]
  certificates        Certificate[]

  @@index([slug])
  @@index([category])
  @@index([level])
  @@index([tier])
  @@index([status])
  @@index([instructorId])
  @@index([rating])
}

enum CourseCategory {
  WEB_SECURITY
  NETWORK_SECURITY
  MALWARE_ANALYSIS
  PENETRATION_TESTING
  CLOUD_SECURITY
  CRYPTOGRAPHY
  INCIDENT_RESPONSE
  SECURITY_FUNDAMENTALS
}

enum CourseLevel {
  FUNDAMENTAL
  INTERMEDIATE
  ADVANCED
}

enum CourseTier {
  FREE
  PREMIUM
}

enum DeliveryMode {
  RECORDED
  LIVE
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// ============================================
// ACADEMY - COURSE MODULES & LESSONS
// ============================================

model CourseModule {
  id              String    @id @default(uuid())
  courseId        String
  title           String
  description     String?   @db.Text
  order           Int
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  course          Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons         Lesson[]

  @@index([courseId])
  @@index([order])
}

model Lesson {
  id              String          @id @default(uuid())
  moduleId        String
  title           String
  description     String?         @db.Text
  type            LessonType
  duration        Int             // Duration in minutes
  videoUrl        String?
  articleContent  String?         @db.Text
  isPreview       Boolean         @default(false)
  order           Int
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  module          CourseModule    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  resources       LessonResource[]
  progress        LessonProgress[]
  quizzes         Quiz[]
  assignments     Assignment[]

  @@index([moduleId])
  @@index([order])
  @@index([type])
}

enum LessonType {
  VIDEO
  ARTICLE
  QUIZ
  ASSIGNMENT
}

model LessonResource {
  id              String    @id @default(uuid())
  lessonId        String
  name            String
  type            ResourceType
  url             String
  size            String?
  createdAt       DateTime  @default(now())

  // Relations
  lesson          Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

enum ResourceType {
  PDF
  ZIP
  LINK
  DOC
}

// ============================================
// ACADEMY - ENROLLMENTS & PROGRESS
// ============================================

model Enrollment {
  id                    String            @id @default(uuid())
  studentId             String
  courseId              String
  enrolledAt            DateTime          @default(now())
  status                EnrollmentStatus  @default(ACTIVE)
  progress              Float             @default(0) // 0-100
  lastAccessedLessonId  String?
  completedAt           DateTime?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relations
  student               Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course                Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
  @@index([status])
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
}

model LessonProgress {
  id              String    @id @default(uuid())
  studentId       String
  lessonId        String
  completed       Boolean   @default(false)
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  student         Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lesson          Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([studentId, lessonId])
  @@index([studentId])
  @@index([lessonId])
  @@index([completed])
}

// ============================================
// ACADEMY - REVIEWS
// ============================================

model Review {
  id              String    @id @default(uuid())
  courseId        String
  userId          String
  studentName     String
  studentAvatar   String?
  rating          Int       // 1-5
  comment         String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  course          Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([userId])
  @@index([rating])
}

// ============================================
// ACADEMY - CERTIFICATES
// ============================================

model Certificate {
  id                  String    @id @default(uuid())
  studentId           String
  courseId            String
  studentName         String
  courseName          String
  issuedAt            DateTime  @default(now())
  verificationCode    String    @unique
  certificateUrl      String?
  createdAt           DateTime  @default(now())

  // Relations
  student             Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course              Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([courseId])
  @@index([verificationCode])
}

// ============================================
// ACADEMY - QUIZZES
// ============================================

model Quiz {
  id              String          @id @default(uuid())
  lessonId        String
  title           String
  description     String?         @db.Text
  passingScore    Int             // Percentage 0-100
  timeLimit       Int?            // In minutes
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  lesson          Lesson          @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions       QuizQuestion[]
  attempts        QuizAttempt[]

  @@index([lessonId])
}

model QuizQuestion {
  id              String          @id @default(uuid())
  quizId          String
  question        String          @db.Text
  type            QuestionType
  options         String[]        // JSON array of options
  correctAnswer   String          @db.Text
  explanation     String?         @db.Text
  order           Int
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  quiz            Quiz            @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([order])
}

enum QuestionType {
  MCQ
  TRUE_FALSE
  MULTIPLE_SELECT
}

model QuizAttempt {
  id              String    @id @default(uuid())
  quizId          String
  studentId       String
  score           Float     // Percentage 0-100
  answers         Json      // JSON object of answers
  passed          Boolean
  attemptedAt     DateTime  @default(now())
  createdAt       DateTime  @default(now())

  // Relations
  quiz            Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student         Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([studentId])
  @@index([passed])
}

// ============================================
// ACADEMY - ASSIGNMENTS
// ============================================

model Assignment {
  id              String                    @id @default(uuid())
  lessonId        String
  title           String
  description     String                    @db.Text
  instructions    String?                   @db.Text
  dueDate         DateTime?
  maxScore        Int                       @default(100)
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  // Relations
  lesson          Lesson                    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  submissions     AssignmentSubmission[]

  @@index([lessonId])
}

model AssignmentSubmission {
  id              String              @id @default(uuid())
  assignmentId    String
  studentId       String
  submissionUrl   String?
  submissionText  String?             @db.Text
  score           Int?
  feedback        String?             @db.Text
  status          SubmissionStatus    @default(PENDING)
  submittedAt     DateTime            @default(now())
  gradedAt        DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  assignment      Assignment          @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student         Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  GRADED
  RETURNED
}
