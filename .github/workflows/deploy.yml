name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸš€ Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            cd /root/HACKTOLIVE
            
            echo "ðŸ”„ Pulling latest changes from GitHub..."
            git pull origin main || git pull origin master
            
            echo "ðŸ³ Building Docker images (without stopping services)..."
            docker-compose build
            
            echo "ðŸ”„ Recreating containers with zero-downtime..."
            docker-compose up -d --force-recreate --remove-orphans
            
            echo "â³ Waiting for services to stabilize..."
            sleep 30
            
            echo "ðŸ“Š Container Status:"
            docker-compose ps
            
            echo "ðŸ” Backend Health Check:"
            for i in {1..10}; do
              if curl -f http://localhost:4000/health > /dev/null 2>&1; then
                echo "âœ… Backend is healthy!"
                break
              fi
              echo "Attempt $i/10: Backend not ready yet..."
              sleep 3
            done
            
            echo "ðŸ” Frontend Health Check:"
            for i in {1..10}; do
              if curl -f http://localhost:3000/ > /dev/null 2>&1; then
                echo "âœ… Frontend is healthy!"
                break
              fi
              echo "Attempt $i/10: Frontend not ready yet..."
              sleep 3
            done
            
            echo "ðŸ” Nginx Health Check:"
            for i in {1..10}; do
              if curl -f http://localhost/ > /dev/null 2>&1; then
                echo "âœ… Nginx is healthy!"
                break
              fi
              echo "Attempt $i/10: Nginx not ready yet..."
              sleep 3
            done
            
            echo "ðŸ§¹ Cleaning up old Docker images (non-blocking)..."
            docker image prune -af --filter "until=24h" || true
            
            echo "âœ… Deployment completed successfully!"
